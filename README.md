# 音频对齐工具

一个集成了音频对齐检测与自动对齐功能的现代化桌面应用程序。

## 功能特点

- **一键流程**：首轮检测 → 自动对齐 → 二次检测 → 导出Excel
- **智能检测**：支持加载机器学习模型（如火眼一号）进行首轮检测
- **自动对齐**：对未对齐音频自动执行对齐处理
- **实时反馈**：进度条、日志、结果表格实时更新
- **全量记录**：导出包含所有处理状态的详细结果
- **现代化界面**：拖拽操作、自适应布局、中文界面

## 安装与使用

### 方法一：直接运行（推荐）

1. 下载打包好的 `音频对齐工具.exe`
2. 双击运行，无需安装任何依赖

### 方法二：从源码运行

1. 安装依赖：
```bash
pip install -r integrated_app/requirements.txt
```

2. 运行程序：
```bash
python -m integrated_app.gui.app
```

### 方法三：命令行批处理

```bash
python -m integrated_app.cli --vocal_dir 原唱目录 --inst_dir 伴奏目录 --output_dir 成品目录 --model 模型文件.joblib
```

## 打包为 exe

### 自动打包

```bash
# 安装打包工具
pip install pyinstaller

# 执行打包
python integrated_app/build.py
```

### 手动打包

```bash
pyinstaller --name="音频对齐工具" --windowed --onefile --icon=integrated_app/assets/icon.svg integrated_app/gui/app.py
```

打包完成后：
- 可执行文件：`dist/音频对齐工具.exe`
- 启动器：`启动音频对齐工具.bat`

## 使用说明

### 界面操作

1. **设置路径**：
   - 原唱目录：包含需要对齐的原唱音频文件
   - 伴奏目录：包含参考伴奏音频文件
   - 成品目录：对齐后的音频文件保存位置

2. **配置选项**：
   - 命名模板：输出文件命名格式，支持 `{id}` 和 `{name}` 占位符
   - 首轮使用模型：可选加载 `.joblib` 模型文件进行智能检测
   - 检测阈值：对齐判断的时间阈值（毫秒）

3. **执行处理**：
   - 点击"开始一键执行"
   - 查看实时进度和日志
   - 在结果表格中查看处理状态

### 文件命名规则

为了正确匹配原唱和伴奏文件，请确保文件名遵循以下格式：
- 原唱文件：`ID-原唱.扩展名`（例如：`12345-原唱.mp3`）
- 伴奏文件：`ID-伴奏.扩展名`（例如：`12345-伴奏.mp3`）

### 输出结果

程序会生成两份 Excel 文件：
- **对齐全量结果.xlsx**：包含所有文件的处理状态
  - 无需对齐：首轮检测已对齐的文件
  - 对齐成功：经过自动对齐并通过二次检测的文件
  - 对齐失败：自动对齐处理失败的文件
  - 二次检测未通过：对齐后仍未能通过检测的文件

- **对齐成功结果.xlsx**：仅包含最终成功的对齐文件

### 支持的音频格式

- MP3 (.mp3)
- WAV (.wav)
- FLAC (.flac)
- OGG (.ogg)
- M4A (.m4a)

## 技术架构

- **GUI框架**：PyQt6
- **音频处理**：librosa, soundfile
- **数值计算**：numpy, scipy
- **机器学习**：scikit-learn
- **数据导出**：pandas, openpyxl

## 项目结构

```
原唱伴奏对齐整合/
├── integrated_app/           # 集成应用
│   ├── gui/                 # 图形界面
│   ├── assets/              # 资源文件
│   ├── orchestrator.py      # 流程编排
│   ├── feature_builder.py   # 特征构建
│   └── cli.py              # 命令行入口
├── audio_algnment_checker2-master/  # 检测器项目
├── 原唱伴奏对齐/              # 对齐工具项目
├── build.py                # 打包脚本
└── requirements.txt        # 依赖列表
```

## 注意事项

1. 首次运行可能需要较长时间加载依赖库
2. 处理大量文件时建议分批进行
3. 确保有足够的磁盘空间存储输出文件
4. 模型文件需要与训练时的特征顺序一致

## 故障排除

### 常见问题

1. **程序无法启动**：
   - 检查是否安装了所有依赖
   - 确认 Python 版本 >= 3.8

2. **音频处理失败**：
   - 检查音频文件格式是否支持
   - 确认文件路径不包含特殊字符

3. **模型加载失败**：
   - 确认模型文件格式为 `.joblib`
   - 检查模型文件是否完整

### 获取帮助

如遇到问题，请检查：
1. 日志输出中的错误信息
2. 输入文件格式和命名是否正确
3. 系统是否有足够的权限和空间
